<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Plan Manager</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        input, select, textarea { width: 100%; padding: 8px; margin: 5px 0; }
        .plan { background: #f9f9f9; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { color: red; }
        .success { color: green; }
        .log-container { background: #1e1e1e; color: #00ff00; padding: 15px; margin: 10px 0; border-radius: 5px; font-family: 'Courier New', monospace; max-height: 400px; overflow-y: auto; }
        .log-entry { margin: 2px 0; }
        .log-phase { color: #ffff00; font-weight: bold; }
        .log-agent { color: #00ffff; }
        .log-success { color: #00ff00; }
        .log-error { color: #ff0000; }
        .log-info { color: #ffffff; }
        .progress-bar { width: 100%; height: 20px; background: #ddd; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4CAF50, #45a049); transition: width 0.3s ease; }
    </style>
</head>
<body>
    <h1>Health Plan Manager</h1>
    
    <!-- Agent Status -->
    <div class="section">
        <h2>ü§ñ Agent System Status</h2>
        <div id="agentStatus">
            <p>Checking agent availability...</p>
        </div>
        <button onclick="checkAgentStatus()">Refresh Agent Status</button>
    </div>
    
    <!-- Generate New Plan -->
    <div class="section">
        <h2>üéØ Generate Health Plan</h2>
        <p><em>Describe the health plan you want to create in natural language. Our AI agents will work together to design the perfect plan for you.</em></p>
        
        <form id="generateForm">
            <label for="planPrompt"><strong>üéØ What kind of health plan do you want?</strong></label>
            <input 
                type="text" 
                id="planPrompt" 
                placeholder="e.g., 'The best plan ever for building muscle quickly - high intensity' or 'Postpartum recovery plan for new moms'"
                required
                style="font-size: 16px; padding: 12px;"
            />
            
            <button type="submit">üöÄ Generate Plan with AI Agents</button>
        </form>
        
        <!-- Progress and Logging Section -->
        <div id="progressSection" style="display: none;">
            <h3>ü§ñ AI Agent Progress</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div id="progressText">Initializing AI agents...</div>
            
            <h4>üß† Agent Activity Log</h4>
            <div class="log-container" id="logContainer">
                <div class="log-entry log-info">ü§ñ AI agents are preparing to work...</div>
            </div>
        </div>
        
        <div id="generateResult"></div>
    </div>
    
    <!-- List Plans -->
    <div class="section">
        <h2>Available Plans</h2>
        <button onclick="loadPlans()">Refresh Plans</button>
        <div id="plansList"></div>
    </div>
    
    <!-- Get Specific Plan -->
    <div class="section">
        <h2>Get Specific Plan</h2>
        <input type="text" id="planId" placeholder="Enter plan ID">
        <button onclick="getPlan()">Get Plan</button>
        <div id="planResult"></div>
    </div>

    <script>
        const API_BASE = 'https://web-production-f15a06.up.railway.app';
        
        // Logging functions
        function addLogEntry(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function updateProgress(percentage, text) {
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = text;
        }
        
        function showProgressSection() {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('logContainer').innerHTML = '<div class="log-entry log-info">Starting plan generation...</div>';
        }
        
        function hideProgressSection() {
            document.getElementById('progressSection').style.display = 'none';
        }
        
        // Generate new plan with enhanced logging
        document.getElementById('generateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Show progress section and reset
            showProgressSection();
            updateProgress(0, 'Initializing AI agents...');
            
            const resultDiv = document.getElementById('generateResult');
            resultDiv.innerHTML = '';
            
            try {
                const planPrompt = document.getElementById('planPrompt').value;
                
                addLogEntry(`üéØ Natural language prompt received:`, 'phase');
                addLogEntry(`üìù "${planPrompt.substring(0, 100)}${planPrompt.length > 100 ? '...' : ''}"`, 'info');
                
                updateProgress(10, 'Analyzing prompt...');
                addLogEntry(`üß† AI agents analyzing your request...`, 'agent');
                
                // Send the natural language prompt to the backend
                const response = await fetch(`${API_BASE}/api/v1/plans/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: planPrompt
                    })
                });
                
                updateProgress(50, 'AI agents working...');
                addLogEntry(`ü§ñ AI agents are collaborating to create your plan...`, 'agent');
                
                const result = await response.json();
                
                if (result.success) {
                    updateProgress(100, 'Plan generated successfully!');
                    addLogEntry(`‚úÖ Plan generated successfully!`, 'success');
                    addLogEntry(`üÜî Plan ID: ${result.data.plan_id}`, 'success');
                    
                    // Show plan details
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ AI-Generated Health Plan Ready!</h3>
                            <p><strong>Plan ID:</strong> ${result.data.plan_id}</p>
                            <p><strong>Overview:</strong> ${result.data.plan[result.data.plan_id].overview.substring(0, 200)}...</p>
                            <button onclick="viewFullPlan('${result.data.plan_id}')">üìã View Full Plan</button>
                        </div>
                    `;
                    
                    loadPlans(); // Refresh the plans list
                } else {
                    updateProgress(0, 'Generation failed');
                    addLogEntry(`‚ùå Error: ${result.message}`, 'error');
                    resultDiv.innerHTML = `<div class="error">‚ùå Error: ${result.message}</div>`;
                }
            } catch (error) {
                updateProgress(0, 'Generation failed');
                addLogEntry(`‚ùå Network/System Error: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
            
            // Hide progress after a delay
            setTimeout(() => {
                hideProgressSection();
            }, 5000);
        });
        
        // Load all plans
        async function loadPlans() {
            const plansDiv = document.getElementById('plansList');
            plansDiv.innerHTML = 'Loading plans...';
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/plans/discover`);
                const result = await response.json();
                
                if (result.success) {
                    const plans = result.data.plans;
                    plansDiv.innerHTML = `
                        <h3>Total Plans: ${result.data.total_plans}</h3>
                        ${Object.keys(plans).map(planId => `
                            <div class="plan">
                                <strong>${planId}</strong>
                                <p>${plans[planId].overview.substring(0, 200)}...</p>
                                <button onclick="getPlanById('${planId}')">View Details</button>
                            </div>
                        `).join('')}
                    `;
                } else {
                    plansDiv.innerHTML = `<div class="error">‚ùå Error: ${result.message}</div>`;
                }
            } catch (error) {
                plansDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        // Get specific plan
        async function getPlan() {
            const planId = document.getElementById('planId').value;
            if (!planId) {
                alert('Please enter a plan ID');
                return;
            }
            await getPlanById(planId);
        }
        
        async function getPlanById(planId) {
            const resultDiv = document.getElementById('planResult');
            resultDiv.innerHTML = 'Loading plan...';
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/plans/${planId}`);
                const result = await response.json();
                
                if (result.success) {
                    const plan = result.data;
                    resultDiv.innerHTML = `
                        <h3>Plan: ${planId}</h3>
                        <div class="plan">
                            <h4>Overview</h4>
                            <p>${plan.overview}</p>
                            
                            <h4>Weekly Split</h4>
                            <ul>${plan.weekly_split.map(day => `<li>${day}</li>`).join('')}</ul>
                            
                            <h4>Days</h4>
                            ${Object.entries(plan.days).map(([day, exercises]) => `
                                <h5>${day}</h5>
                                <ul>${exercises.map(ex => `<li>${ex}</li>`).join('')}</ul>
                            `).join('')}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Error: ${result.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        // View full plan details
        async function viewFullPlan(planId) {
            const resultDiv = document.getElementById('generateResult');
            resultDiv.innerHTML = 'Loading full plan...';
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/plans/${planId}`);
                const result = await response.json();
                
                if (result.success) {
                    const plan = result.data;
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>üìã Full Plan: ${planId}</h3>
                            <div class="plan">
                                <h4>Overview</h4>
                                <p>${plan.overview}</p>
                                
                                <h4>Weekly Split</h4>
                                <ul>${plan.weekly_split.map(day => `<li>${day}</li>`).join('')}</ul>
                                
                                <h4>Days & Exercises</h4>
                                ${Object.entries(plan.days).map(([day, exercises]) => `
                                    <h5>${day}</h5>
                                    <ul>${exercises.map(ex => `<li>${ex}</li>`).join('')}</ul>
                                `).join('')}
                                
                                <h4>Global Rules</h4>
                                <ul>${plan.global_rules.map(rule => `<li><strong>${rule.title}:</strong> ${rule.text}</li>`).join('')}</ul>
                                
                                <h4>Nutrition</h4>
                                <p><strong>Goal:</strong> ${plan.nutrition.goal}</p>
                                <p><strong>Protein:</strong> ${plan.nutrition.protein}</p>
                                <p><strong>Carbs:</strong> ${plan.nutrition.carbohydrate}</p>
                                <p><strong>Fat:</strong> ${plan.nutrition.fat}</p>
                                
                                <h4>Conditioning & Recovery</h4>
                                <ul>${plan.conditioning_and_recovery.map(item => `<li>${item}</li>`).join('')}</ul>
                            </div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Error: ${result.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        // Check agent system status
        async function checkAgentStatus() {
            const statusDiv = document.getElementById('agentStatus');
            statusDiv.innerHTML = 'Checking agents...';
            
            try {
                // Test OpenAI connectivity
                const openaiResponse = await fetch(`${API_BASE}/api/v1/test/openai`);
                const openaiResult = await openaiResponse.json();
                
                let statusHTML = '<h3>Agent System Status:</h3>';
                
                if (openaiResult.success) {
                    statusHTML += `
                        <div class="success">
                            <p>‚úÖ <strong>OpenAI API:</strong> Connected and working</p>
                            <p>ü§ñ <strong>Model:</strong> ${openaiResult.data.model_used}</p>
                            <p>üîë <strong>API Key:</strong> ${openaiResult.data.api_key_configured ? 'Configured' : 'Missing'}</p>
                        </div>
                    `;
                } else {
                    statusHTML += `<div class="error">‚ùå <strong>OpenAI API:</strong> Connection failed</div>`;
                }
                
                // Test orchestrator availability
                try {
                    const testResponse = await fetch(`${API_BASE}/api/v1/plans/generate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            population: "test",
                            goals: ["test"],
                            constraints: [],
                            timeline: "1_week",
                            fitness_level: "beginner"
                        })
                    });
                    
                    if (testResponse.ok) {
                        statusHTML += '<div class="success">‚úÖ <strong>Orchestrator Agent:</strong> Available and responding</div>';
                    } else {
                        statusHTML += '<div class="error">‚ùå <strong>Orchestrator Agent:</strong> Not responding</div>';
                    }
                } catch (error) {
                    statusHTML += '<div class="error">‚ùå <strong>Orchestrator Agent:</strong> Connection failed</div>';
                }
                
                statusHTML += `
                    <h4>Available Agents:</h4>
                    <ul>
                        <li>üî¨ <strong>Research Agent:</strong> Queries research papers and guidelines</li>
                        <li>üí™ <strong>Fitness Agent:</strong> Designs exercise programs</li>
                        <li>ü•ó <strong>Nutrition Agent:</strong> Plans nutrition strategies</li>
                        <li>üéØ <strong>Motivation Agent:</strong> Provides encouragement</li>
                        <li>üõ°Ô∏è <strong>Safety Agent:</strong> Validates plan safety</li>
                        <li>üéº <strong>Orchestrator Agent:</strong> Coordinates all agents</li>
                    </ul>
                `;
                
                statusDiv.innerHTML = statusHTML;
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">‚ùå Error checking agent status: ${error.message}</div>`;
            }
        }
        
        // Load plans on page load
        loadPlans();
        // Check agent status on page load
        checkAgentStatus();
    </script>
</body>
</html>
